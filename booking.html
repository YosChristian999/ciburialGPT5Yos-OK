<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- CSP (samakan dengan index, SATU saja, jangan dobel) -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    img-src 'self' data: https:;
    media-src 'self' https: blob:;
    style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com;
    font-src  'self' data: https://fonts.gstatic.com;
    script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://app.sandbox.midtrans.com https://app.midtrans.com;
    connect-src 'self' https://api.sandbox.midtrans.com https://api.midtrans.com https://app.sandbox.midtrans.com https://app.midtrans.com https://cdn.jsdelivr.net;
    frame-src https://app.sandbox.midtrans.com https://app.midtrans.com;
    base-uri 'self';
    object-src 'none';
    upgrade-insecure-requests;
  ">

  <title>Booking · Ciburial Puncak</title>

  <!-- CSS eksternal -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- CSS project (PASTIKAN path ini) -->
  <link href="assets/css/style.css" rel="stylesheet">
</head>
<body class="bg-dark text-light" style="font-family:'Poppins',system-ui,Segoe UI,Arial">

<nav class="navbar navbar-expand-lg navbar-dark bg-nav sticky-top border-bottom border-opacity-25">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
      <img src="assets/images/logo.png" width="28" height="28" alt="">
      <span class="fw-bold">Ciburial Puncak</span>
    </a>
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="nav">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item"><a class="nav-link" href="about.html">Tentang Kami</a></li>
        <li class="nav-item"><a class="nav-link" href="index.html#payment">Pembayaran</a></li>
        <li class="nav-item"><a class="nav-link" href="login.html">Login</a></li>
        <li class="nav-item"><a class="nav-link text-warning" href="admin.html">Admin</a></li>
      </ul>
    </div>
  </div>
</nav>

<header class="py-5 bg-dark border-bottom border-opacity-25">
  <div class="container">
    <h1 class="h3 mb-2">Katalog Villa</h1>
    <p class="text-secondary mb-0">Cari dan filter semua villa yang tersedia.</p>
  </div>
</header>

<main class="container my-4">
  <!-- Toolbar filter -->
  <section class="mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md">
        <label class="form-label small">Cari nama/teks</label>
        <input id="qText" type="search" class="form-control" placeholder="mis. kolam, modern, view">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small">Harga min</label>
        <input id="qMin" type="number" class="form-control" min="0" placeholder="0">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small">Harga max</label>
        <input id="qMax" type="number" class="form-control" min="0" placeholder="99999999">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label small">Kapasitas ≥</label>
        <input id="qCap" type="number" class="form-control" min="0" placeholder="0">
      </div>
      <div class="col-6 col-md-2 d-grid">
        <button id="qReset" class="btn btn-outline-secondary">Reset</button>
      </div>
    </div>
  </section>

  <!-- Grid all villas -->
  <section id="vlist">
    <div id="vListGrid" class="row g-3"><!-- skeleton/data --></div>
  </section>
</main>

<footer class="py-4 mt-5 bg-nav border-top border-opacity-25">
  <div class="container d-flex justify-content-between small">
    <div>© 2025 Ciburial Puncak</div>
    <div class="text-secondary">Powered by Midtrans</div>
  </div>
</footer>

<!-- JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Helpers
  const rupiah = n => 'Rp ' + Number(n||0).toLocaleString('id-ID');
  const basePath = () => location.pathname.replace(/[^\/]+$/, '');
  function imgFallback(img){
    if(img.dataset.try1!=='1' && img.dataset.alt1){ img.dataset.try1='1'; img.src = img.dataset.alt1; return; }
    if(img.dataset.try2!=='1' && img.dataset.alt2){ img.dataset.try2='1'; img.src = img.dataset.alt2; return; }
    img.src = basePath() + 'assets/images/pleaceholder.jpg';
  }
  const COVER_BY_ID = {1:'Villa1Arikokena.png',2:'Villa2Tiger.png',3:'Villa3Cahaya.png',4:'Villa4BataCCitra.png',5:'Villa5BataAgricon.png',6:'Villa6Dinar3.png',7:'Villa7Yangtiq.png',8:'Villa8HDO.jpg',9:'Villa9Archie.jpg',10:'Villa10Rick.png',11:'Villa11Zambrud.jpg'};
  function coverCandidates(v){
    const c=[]; if(v.url_gambar){ const p=String(v.url_gambar).replace(/^\/*/,''); c.push(basePath()+p); }
    if(COVER_BY_ID[v.id]) c.push(basePath()+'assets/images/VillaPic/'+COVER_BY_ID[v.id]);
    c.push(basePath()+'assets/images/pleaceholder.jpg'); return c;
  }

  let RAW=[], VIEW=[];
  async function fetchVillas(){
    const res = await fetch('/backend/api/villas/list.php', {cache:'no-store'});
    const txt = await res.text();
    let j; try{ j=JSON.parse(txt);}catch{ throw new Error('list.php bukan JSON: '+txt.slice(0,200));}
    if(j.ok===false) throw new Error(j.error||'Gagal memuat');
    return Array.isArray(j)? j : (j.villas||[]);
  }
  function skeleton(){
    const wrap=document.getElementById('vListGrid');
    wrap.innerHTML = Array.from({length:9}).map(()=>`
      <div class="col-12 col-md-6 col-lg-4">
        <article class="card qm-card h-100 loading">
          <div class="cover skeleton" style="height:180px"></div>
          <div class="card-body">
            <div class="skeleton mb-2" style="height:20px;width:70%"></div>
            <div class="skeleton mb-2" style="height:14px;width:90%"></div>
            <div class="skeleton mb-2" style="height:14px;width:85%"></div>
            <div class="d-flex justify-content-between">
              <div class="skeleton" style="height:16px;width:100px"></div>
              <div class="skeleton" style="height:32px;width:90px;border-radius:6px"></div>
            </div>
          </div>
        </article>
      </div>`).join('');
  }
  function render(list){
    const wrap=document.getElementById('vListGrid');
    if(!list.length){
      wrap.innerHTML = `<div class="col-12"><div class="alert alert-warning">Tidak ada villa yang cocok.</div></div>`;
      return;
    }
    wrap.innerHTML = list.map(v=>{
      const cands=coverCandidates(v), first=cands[0], alt1=cands[1]||'', alt2=cands[2]||'';
      return `
      <div class="col-12 col-md-6 col-lg-4">
        <article class="card qm-card h-100">
          <img class="cover" src="${first}" data-alt1="${alt1}" data-alt2="${alt2}" alt="${v.nama_villa||v.nama||'Villa'}" onerror="imgFallback(this)">
          <div class="card-body">
            <h6 class="mb-1">${v.nama_villa||v.nama||'Villa'}</h6>
            <p class="small text-secondary">${(v.deskripsi||'').slice(0,150)}</p>
            <div class="d-flex justify-content-between align-items-center">
              <span class="text-info fw-semibold">${rupiah(v.harga_per_malam||v.harga)}/malam</span>
              <a class="btn btn-info btn-sm" href="${basePath()}detail.html?villa=${encodeURIComponent(v.id)}">Detail</a>
            </div>
          </div>
        </article>
      </div>`;
    }).join('');
  }
  function applyFilter(){
    const q=(document.getElementById('qText')?.value||'').toLowerCase();
    const min=Number(document.getElementById('qMin')?.value||0);
    const max=Number(document.getElementById('qMax')?.value||0);
    const cap=Number(document.getElementById('qCap')?.value||0);
    VIEW = RAW.filter(v=>{
      const nama=(v.nama_villa||v.nama||'').toLowerCase();
      const desk=(v.deskripsi||'').toLowerCase();
      const harga=Number(v.harga_per_malam||v.harga||0);
      const kapas=Number(v.kapasitas_maksimal||v.kapasitas||0);
      if(q && !(nama.includes(q)||desk.includes(q))) return false;
      if(min && harga<min) return false;
      if(max && harga>max) return false;
      if(cap && kapas<cap) return false;
      return true;
    });
    render(VIEW);
  }

  (async ()=>{
    skeleton();
    try{
      RAW = await fetchVillas();
      VIEW = RAW.slice(0);
      render(VIEW);
    }catch(e){
      document.getElementById('vListGrid').innerHTML =
        `<div class="col-12"><div class="alert alert-danger">Gagal memuat data villa. ${e.message}</div></div>`;
    }
  })();

  document.getElementById('qText')?.addEventListener('input', applyFilter);
  ['qMin','qMax','qCap'].forEach(id=>document.getElementById(id)?.addEventListener('change', applyFilter));
  document.getElementById('qReset')?.addEventListener('click', ()=>{
    ['qText','qMin','qMax','qCap'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
    applyFilter();
  });
</script>
</body>
</html>
